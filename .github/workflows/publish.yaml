name: Publish

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:

  build:

    runs-on: ubuntu-22.04

    steps:
      - name: Checkout source
        uses: actions/checkout@v3
        with:
          path: main

      - uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            main/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install trunk
        run: |
          curl -sL https://github.com/thedodd/trunk/releases/download/v0.16.0/trunk-x86_64-unknown-linux-gnu.tar.gz -o trunk-x86_64-unknown-linux-gnu.tar.gz
          tar xzf trunk-x86_64-unknown-linux-gnu.tar.gz
          sudo install trunk /usr/bin/trunk

      - uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: cd main && npm install

      - run: rustup target add wasm32-unknown-unknown

      - name: Build page
        run: cd main && trunk build --release

      - name: Checkout current publish branch
        uses: actions/checkout@v3
        with:
          ref: publish
          path: publish

      - run: |
          cd "$GITHUB_WORKSPACE/publish"
          git config user.name "GitHub Actions" && git config user.email "actions@users.noreply.github.com"

      - name: Update content
        run: |
          cd "$GITHUB_WORKSPACE/publish"
          rm * -Rf
          cp -a "$GITHUB_WORKSPACE"/main/dist/* .
          
          mkdir -p php
          cp -a "$GITHUB_WORKSPACE"/main/php/* ./php/
          cp -p "$GITHUB_WORKSPACE"/main/proxy.php ./
          
          git add -A
          if ! git diff --cached --exit-code; then
            echo "Changes have been detected, publishing to repo."
            git commit -m "Build ${GITHUB_WORKFLOW} for ${GITHUB_SHA}"
            git log --graph --abbrev-commit --date=relative -n 5
            git push origin
          else
            echo "No changes have been detected since last build, nothing to publish"
          fi
